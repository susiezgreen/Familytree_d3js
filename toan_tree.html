<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type="text/css">
        

        
    .node text {

        fill: white;
        /*fill:#584d41; /*greybrown*/
        text-anchor: middle;
        alignment-baseline: middle;
        font-size: 10px;
        /* font-family: "Tempus Sans ITC" 
        /*font-family: "Gabriola"*/
        font-family: "Book Antiqua";
    }
    
    .button-Style {
        fill: white;        
        stroke:grey;
        rx:4;
        ry:4;
        
    
    }
    
    .button-Style-Cousins {
        fill: white;        
        stroke:grey;
        rx:4;
        ry:4;
     }
     
    .button-Style-Debug {
        fill: white;        
        stroke:grey;
        rx:4;
        ry:4;
        
    }
    
    .button-Style-Dogleg {
        fill: white;        
        stroke:grey;
        rx:4;
        ry:4;
        
    }
    
    .button-Style-curves {
        fill: white;        
        stroke:grey;
        rx:4;
        ry:4;
        
    }

    
    .button-Style-scaleNames {
        fill: white;        
        stroke:grey;
        rx:4;
        ry:4;
        
    }    
    .button-Text {
        fill:grey;
        font-size:10px;
        text-anchor:left;
    
    }            


    </style>
</head>
<body>
<svg width="1330" height="760"  ></svg>

<script src="./d3/d3.v4.min.js" type="text/javascript"></script>
<script src="./d3/d3-selection-multi.js"></script>

<script type="text/javascript">



// SET VARIABLES -----------------------------------------------
    var backgroundcol = "white";
    var panelcol = "white";
    
    
    var idealwidth = 1330;
    var idealheight = 760;
    
    var maxBranch = 5;
    
    //BOXES
    var boxSize = 120;
    var marriageBoxSize = 40;
    var boxStrokeWidth = 5;
    var boxOpacity = 1;
    var cornercurve = 5;
    
    //TEXT
    var topSpacing = 10;   // gap at top of box
    var textSpacing = 10;  // gaps between lines
    var fitNames = 40; //60 = no fitting, 20 = Scaled to fit
    var nameScale = 1; // 1 = fit exactly to box    
    var yearScale = 14;    
    var birthplaceScale = 12;
    var occupationScale = 12;
    var customScale = 12;
    
    var textfont = "Book Antiqua";
    
    
    
    //SIMULATION
    var linkDistance = 40;
    var linkStrength = 0.1;
    var chargeStrength = 25;  //boxes/marriage
    var boxCharge = 25;
    var marriageCharge =  25;
    var chargeMaxDistance = 25;
    var verticalPositionStrength = 0.2;
    var leglength = 60;
    var generationspacing = 8;
    var collisionPadding = 3;
    
    //box fill/stroke Colour variations 
    //        hueRange(1)   hueOffset(0)   sat(1)    val(1)   fade(0)   dark(0)
    var bfv = [     1,        0.5,         0.0,        1,       1,       0];
    var bsv = [     1,        0.5,         0.7,        1,       0.7,       0.1];
    
    //SHADOWS
    var shadowOffset = [6, 6] ;
    var shadowStrength = 0.2 ;
    
    //LINKS           main branch    other branches
    var linkWidth = [      40        ,         20       ];
    //link Colour variations 
    var lv = [     1,        0.5,         0.5,        1,       0.9,       0];
    
    var useGenLinkScaling = true; //whether to scale the links smaller for earlier generations
    var topScalingGen = 6;  // the links will get smaller until this far back
    
    var curveLinktoMarriage = 20;
    var curveLinktoPerson = 100; //size of curve
    var scaleLinkCurves = false; //make the corners wider the longer the line
    
    //TEXT
    var textColour = "DimGray";
    
    //BUTTONS
    var buttonWidth = 16;
    var buttonColWidth = 24;
    
    //Debug Colours
    //        hueRange(1)   hueOffset(0)   sat(1)    val(1)   fade(0)   dark(0)
    var bgv = [     1,        0.5,         1,        1,       0.25,       0];
    var bbv = [     1,        0,         1.5,        1.2,       0,       0.1];    
    
// ----------------------------------------------- END SET VARIABLES 
// CREATE VARIABLES -----------------------------------------------

    var colors10 = d3.scaleOrdinal(d3.schemeCategory10);
    var colors20c = d3.scaleOrdinal(d3.schemeCategory20c);
    var rescale = d3.scaleLinear().domain([0,1330]).range([0,d3.select("svg").attr("width")]);


    
// ----------------------------------------------- END CREATE VARIABLES 
    var canvas = document.createElement('canvas');
    var context = canvas.getContext('2d');
    //canvas for drawing text to get font sizes


    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height"),
        node,
        link;
        
     var canvas = svg.append("rect")
        .attr("width", "80%")
        .attr("height", "100%")
        .attr("fill", backgroundcol);
    
    var panel = svg.append("rect")
        .attr("x", "80%")
        .attr("width", "20%")
        .attr("height", "100%")
        .attr("fill", panelcol);

    var g = svg.append("g")
        .attr("class", "svg-graph");

// CREATE FORCE SIMULATION ++++++++++++++++++++++++++++++++++++++++++++++++++
    var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(linkId).distance(linkDist).strength(linkStrength))
        .force("charge", d3.forceManyBody().strength(chargeStrengthFunc(boxCharge,marriageCharge)).distanceMax(chargeMaxDistance))
        //.force("center", d3.forceCenter(width / 2, height / 2))
        .force('y', d3.forceY().y(boxVertPosition).strength(verticalPositionStrength))
        .force('collision', d3.forceCollide().radius(boxCollision).iterations(4))
        ;

// ++++++++++++++++++++++++++++++++++++++++++++++++++ END CREATE FORCE SIMULATION


// READ JSON FILE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
    d3.json("toan.json", function (error, graph) {
        if (error) throw error;
        update(graph.links, graph.nodes);
        
         //json.Nodes.forEach(function(d) { d.textHeight = 0;  });

    })


    function update(links, nodes) {
    
    
// LINKS =====================================================
        link = g.selectAll(".path")
            .data(links)
            .enter()
            .append("path")
            .attr("stroke-width", linkThickness)
            .style("stroke-linejoin","round")
            .style("fill","none")
            .style("stroke", linkColour)
            .style("opacity",linkOpacity(10));
//=====================================================END LINKS  //




// NODES =======================================================
        node = g.selectAll(".node")
            .data(nodes)
            .enter()
            .append("g")
            .attr("class", "node")
            .attr("x", function (d) { return d.px;})
            .on('click', releasenode)
            .call(d3.drag()
                                            .on("start", dragstarted)
                                            .on("drag", dragged)
                                            .on("end", dragended)
                    
            );
//======================================================END NODES   //

// HIDDEN TEXT -------------------------------------------------------------------


//names            
    for (i = 0; i < 4; i++) {    
        node.append("text")
            .text(function(d){return d.names[i]})
            .style("font-weight", "bold" )
            .style("opacity", 0)
            .style("font-size",namesize(i,fitNames,nameScale))
            .attrs({"dy": nameHeight(),  "text-anchor":"middle", "class": "text"});
             }

//years
        node.append("text")
            .text(function(d){return d.years[0]})
            //.text(nameheight(0))
            .style("font-weight", "bold" )
            .style("opacity", 0)
            .style("font-size",textSize(yearScale))
            .attrs({"dy": textHeight(yearScale),"text-anchor":"middle","class": "text"});            

// places

    for (i = 0; i < 4; i++) {    
        node.append("text")
            .text(function(d){return d.places[i]})
            .style("font-weight", "bold" )
            .style("opacity", 0)
            .style("font-size",textSize(birthplaceScale))
            .attrs({"dy": textHeight(birthplaceScale), "text-anchor":"middle", "class": "text"});
             }
             
             
// occupation
             
     for (i = 0; i < 4; i++) { 
        node.append("text")
            .text(function(d){return d.occupation[i]})
            .style("font-weight", "bold" )
            .style("opacity", 0)
            .style("font-size",textSize(occupationScale))
            .attrs({"dy": textHeight(occupationScale),"text-anchor":"middle","class": "text"});
             }
             
// custom
    for (i = 0; i < 4; i++) { 
        node.append("text")
            .text(function(d){return d.custom[i]})
            .style("font-weight", "bold" )
            .style("opacity", 0)
            .style("font-size",textSize(customScale))
            .attrs({"dy": textHeight(customScale),"text-anchor":"middle","class": "text"});
             }
             

//======================================================END HIDDEN TEXT   //       


// INFO BOXES -----------------------------------------------------

        //shadowbox
        node.append("rect")
            .attrs({"width": boxWidth(100),
                    "height": boxHeight(100),
                    "x":shadowBoxX(shadowOffset),
                    "y":shadowBoxY(shadowOffset),
                    "rx":cornercurve, "ry":cornercurve})  //curved corners})
            .style("fill", "grey")
            .style('stroke-width', boxStrokeWidth*2)
            .style("opacity",shadowStrength)
            .style("stroke","grey");

            
        node.append("rect")
            .attrs({"width": boxWidth(100),
                    "height": boxHeightReset(100),
                    "x":boxX(),
                    "y":boxY(),
                    "rx":cornercurve, "ry":cornercurve})  //curved corners})
            .style("fill", boxColour)
            .style('stroke-width', boxStrokeWidth)
            .style("opacity",boxOpacity)
            .style("stroke",boxStrokeColour);
//-----------------------------------------------------END INFO BOXES //
            



// TEXT -------------------------------------------------------------------


//names            
    for (i = 0; i < 4; i++) {    
        node.append("text")
            .text(function(d){return d.names[i]})
            .style("font-weight", "bold" )
            .style("fill", textColour)
            .style("font-size",namesize(i,fitNames,nameScale))
            .attrs({"dy": nameHeight(),  "text-anchor":"middle", "class": "text"});
             }

//years
        node.append("text")
            .text(function(d){return d.years[0]})
            //.text(nameheight(0))
            .style("font-weight", "bold" )
            .style("fill", textColour)
            .style("font-size",textSize(yearScale))
            .attrs({"dy": textHeight(yearScale),"text-anchor":"middle","class": "text"});            

// places

    for (i = 0; i < 4; i++) {    
        node.append("text")
            .text(function(d){return d.places[i]})
            .style("font-weight", "bold" )
            .style("fill", textColour)
            .style("font-size",textSize(birthplaceScale))
            .attrs({"dy": textHeight(birthplaceScale), "text-anchor":"middle", "class": "text"});
             }
             
             
// occupation
             
     for (i = 0; i < 4; i++) { 
        node.append("text")
            .text(function(d){return d.occupation[i]})
            .style("font-weight", "bold" )
            .style("fill", textColour)
            .style("font-size",textSize(occupationScale))
            .attrs({"dy": textHeight(occupationScale),"text-anchor":"middle","class": "text"});
             }
             
// custom
    for (i = 0; i < 4; i++) { 
        node.append("text")
            .text(function(d){return d.custom[i]})
            .style("font-weight", "bold" )
            .style("fill", textColour)
            .style("font-size",textSize(customScale))
            .attrs({"dy": textHeight(customScale),"text-anchor":"middle","class": "text"});
             }

//======================================================END TEXT   //            


            
            
//Changing Parameters
var showNone = (function(){
    return function(){
        node.selectAll("rect").style("fill", boxColour);
        g.selectAll("path").style("stroke", linkColour);
        d3.selectAll(".button-Style-Debug").style("fill", "white");
        d3.select(this).style("fill", "Gray");
    }
})();

var showGenerations = (function(){
    return function(){
        node.selectAll("rect").style("fill", genColour);
        g.selectAll("path").style("stroke", genColour);
        d3.selectAll(".button-Style-Debug").style("fill", "white");
        d3.select(this).style("fill", "Gray");
    }
})();

var showBranches = (function(){
    return function(){
        node.selectAll("rect").style("fill", branchColour);
        g.selectAll("path").style("stroke", branchColour);
        d3.selectAll(".button-Style-Debug").style("fill", "white");
        d3.select(this).style("fill", "Gray");
    }
})();


function branches(maxBranch){
        return function (d){
            node.selectAll("rect").attr("width",boxWidth(maxBranch)).attr("height",boxHeight(maxBranch));
            node.selectAll("text").style("opacity", textOpacity(maxBranch));
            g.selectAll("path").style("opacity", linkOpacity(maxBranch));
            d3.selectAll(".button-Style-Cousins").style("fill", "white");
            d3.select(this).style("fill", "Gray");
            restart();
            }
    } 
    
function bgCol(col){
        return function (d){
            canvas.attr("fill", col);}
    }
       
function dogLegLength(length){
        return function (d){
            leglength = length;
            d3.selectAll(".button-Style-Dogleg").style("fill", "white");
            d3.select(this).style("fill", "Gray");}
    }    

function curveLinkLength(length){
        return function (d){
            
            curveLinktoMarriage = length*0.2;
            curveLinktoPerson = length; 
            d3.selectAll(".button-Style-curves").style("fill", "white");
            d3.select(this).style("fill", "Gray");}
    }  



    
// PANEL ----------------------------------------------------------------------

//              BACKGROUND COLOURS
svg.append("text")
            .attrs({"class": "button-Text",
                    "x": "81%", "y":"5%", 
                    })
            .style("font-size",rescale(12))
            .text("BACKGROUND COLOURS");   

bgcols = ["white", "WhiteSmoke", "GhostWhite", "Ivory",  "Linen", "AntiqueWhite", "Snow", "AliceBlue",
            "Gainsboro", "Silver", "SlateGray", "DarkSlateGray","SaddleBrown", "DarkOliveGreen", "Teal", "MidnightBlue"];   
var offset = 0;
for (i = 0; i < bgcols.length; i++) {
    if(i < bgcols.length/2){offset=0}
    else{offset=1}
    svg.append("rect")        
        .attrs({"width": rescale(buttonColWidth),"height": rescale(buttonColWidth), "x": rescale(idealwidth*81/100 +i*30-(30*offset*bgcols.length/2)), "y":rescale(idealheight*(offset*4+6)/100),"class": "button-Style",})  
        .style("fill", bgcols[i])
        .on("click", bgCol(bgcols[i]));  
        
}

//              COUSINS
svg.append("text")
            .attrs({"class": "button-Text",
                    "x": "81%", "y":"18%", 
                    })
            .style("font-size",rescale(12))
            .text("HOW MANY COUSINS?");   

//Branches Switches            
svg.append("rect")        
        .attrs({"width": rescale(buttonWidth),"height": rescale(buttonWidth),"x": "81%", "y":"20%","class": "button-Style-Cousins",})         
        .on("click", branches(0));            
        
svg.append("rect")        
        .attrs({"width": rescale(buttonWidth),"height": rescale(buttonWidth),"x": "81%", "y":"23%","class": "button-Style-Cousins",})         
        .on("click", branches(1));            

svg.append("rect")        
        .attrs({"width": rescale(buttonWidth), "height": rescale(buttonWidth), "x": "81%", "y":"26%","class": "button-Style-Cousins",})         
        .on("click", branches(2));      
        
svg.append("rect")        
        .attrs({"width": rescale(buttonWidth),"height": rescale(buttonWidth),"x": "81%", "y":"29%","class": "button-Style-Cousins",})         
        .on("click", branches(3));         
        
svg.append("rect")        
        .attrs({"width": rescale(buttonWidth),"height": rescale(buttonWidth),"x": "81%", "y":"32%","class": "button-Style-Cousins",})         
        .style("fill", "Gray")
        .on("click", branches(100));          

        
svg.append("text")
            .attrs({"class": "button-Text", "x":  rescale(idealwidth*81/100+buttonWidth+5), "y":rescale(idealheight*20/100+buttonWidth*7/10),})
            .style("font-size",rescale(12))
            .text("Just Direct Ancestors"); 
svg.append("text")
            .attrs({"class": "button-Text", "x":  rescale(idealwidth*81/100+buttonWidth+5), "y":rescale(idealheight*23/100+buttonWidth*7/10),})
            .style("font-size",rescale(12))
            .text("Ancestors' Brothers and Sisters"); 
svg.append("text")
            .attrs({"class": "button-Text", "x":  rescale(idealwidth*81/100+buttonWidth+5), "y":rescale(idealheight*26/100+buttonWidth*7/10),})
            .style("font-size",rescale(12))
            .text("Ancestors' Brothers and Sisters' Children"); 
svg.append("text")
            .attrs({"class": "button-Text", "x":  rescale(idealwidth*81/100+buttonWidth+5), "y":rescale(idealheight*29/100+buttonWidth*7/10),})
            .style("font-size",rescale(12))
            .text("Ancestors' Brothers and Sisters' Grandchildren"); 
svg.append("text")
            .attrs({"class": "button-Text", "x":  rescale(idealwidth*81/100+buttonWidth+5), "y":rescale(idealheight*32/100+buttonWidth*7/10),})
            .style("font-size",rescale(12))
            .text("Everyone in the GEDCOM");             




//              DEBUG COLOURS
svg.append("text")
            .attrs({"class": "button-Text",
                    "x": "81%", "y":"50%", 
                    })
            .style("font-size",rescale(12))
            .text("DEBUG COLOURS");   

svg.append("rect")        
        .attrs({"width": rescale(buttonWidth),
                "height": rescale(buttonWidth),
                "x": "81%", "y":rescale(idealheight*51/100),
                "class": "button-Style-Debug",})         
        .on("click", showGenerations);    

svg.append("rect")        
        .attrs({"width": rescale(buttonWidth),
                "height": rescale(buttonWidth),
                "x": "88%", "y":rescale(idealheight*51/100),
                "class": "button-Style-Debug",})         
        .on("click", showBranches);    
        
svg.append("rect")        
        .attrs({"width": rescale(buttonWidth),
                "height": rescale(buttonWidth),
                "x": "94%", "y":rescale(idealheight*51/100),
                "class": "button-Style-Debug",}) 
        .style("fill", "Gray")
        .on("click", showNone);    
        
        
svg.append("text")
            .attrs({"class": "button-Text",
                    "x": rescale(idealwidth*81/100+buttonWidth+2), "y":rescale(idealheight*51/100+buttonWidth*7/10), 
                    })
            .style("font-size",rescale(12))
            .text("Generations");     

svg.append("text")
            .attrs({"class": "button-Text",
                    "x": rescale(idealwidth*88/100+buttonWidth+2), "y":rescale(idealheight*51/100+buttonWidth*7/10), 
                    })
            .style("font-size",rescale(12))
            .text("Branches"); 
            
svg.append("text")
            .attrs({"class": "button-Text",
                    "x": rescale(idealwidth*94/100+buttonWidth+2), "y":rescale(idealheight*51/100+buttonWidth*7/10), 
                    })
            .style("font-size",rescale(12))

            .text("Off"); 

//LINK FORMATTING
svg.append("text")
            .attrs({"class": "button-Text",  "x": "81%","y":rescale(idealheight*60/100), }) 
            .style("font-size",rescale(12)).text("SCALE DOGLEG LINKS");   
            
svg.append("rect")        
        .attrs({"width": rescale(buttonWidth), "height": rescale(buttonWidth), "x": "84%", "y":rescale(idealheight*61/100), "class": "button-Style-Dogleg",}) 
        .style("fill", "white") .on("click", dogLegLength(leglength-30));           
        
svg.append("rect")        
        .attrs({"width": rescale(buttonWidth), "height": rescale(buttonWidth), "x": "86%", "y":rescale(idealheight*61/100), "class": "button-Style-Dogleg",}) 
        .style("fill", "white") .on("click", dogLegLength(leglength-20));      

svg.append("rect")        
        .attrs({"width": rescale(buttonWidth), "height": rescale(buttonWidth), "x": "88%", "y":rescale(idealheight*61/100), "class": "button-Style-Dogleg",}) 
        .style("fill", "white") .on("click", dogLegLength(leglength-10));    

svg.append("rect")        
        .attrs({"width": rescale(buttonWidth), "height": rescale(buttonWidth), "x": "90%", "y":rescale(idealheight*61/100), "class": "button-Style-Dogleg",}) 
        .style("fill", "grey") .on("click", dogLegLength(leglength));    
        
svg.append("rect")        
        .attrs({"width": rescale(buttonWidth), "height": rescale(buttonWidth), "x": "92%", "y":rescale(idealheight*61/100), "class": "button-Style-Dogleg",}) 
        .style("fill", "white") .on("click", dogLegLength(leglength+10));    

svg.append("rect")        
        .attrs({"width": rescale(buttonWidth), "height": rescale(buttonWidth), "x": "94%", "y":rescale(idealheight*61/100), "class": "button-Style-Dogleg",}) 
        .style("fill", "white") .on("click", dogLegLength(leglength+20));   

svg.append("rect")        
        .attrs({"width": rescale(buttonWidth), "height": rescale(buttonWidth), "x": "96%", "y":rescale(idealheight*61/100), "class": "button-Style-Dogleg",}) 
        .style("fill", "white") .on("click", dogLegLength(leglength+30)); 
        
//CURVES

svg.append("text")
            .attrs({"class": "button-Text",  "x": "81%","y":rescale(idealheight*66/100), }) 
            .style("font-size",rescale(12)).text("SQUARE OR CURVED LINKS");   
            
svg.append("rect")        
        .attrs({"width": rescale(buttonWidth), "height": rescale(buttonWidth), "x": "84%", "y":rescale(idealheight*67/100), "class": "button-Style-curves",}) 
        .style("fill", "white") .on("click", curveLinkLength(curveLinktoPerson*0.01));           
        
svg.append("rect")        
        .attrs({"width": rescale(buttonWidth), "height": rescale(buttonWidth), "x": "86%", "y":rescale(idealheight*67/100), "class": "button-Style-curves",}) 
        .style("fill", "white") .on("click", curveLinkLength(curveLinktoPerson*0.1));      

svg.append("rect")        
        .attrs({"width": rescale(buttonWidth), "height": rescale(buttonWidth), "x": "88%", "y":rescale(idealheight*67/100), "class": "button-Style-curves",}) 
        .style("fill", "white") .on("click", curveLinkLength(curveLinktoPerson*0.25));    

svg.append("rect")        
        .attrs({"width": rescale(buttonWidth), "height": rescale(buttonWidth), "x": "90%", "y":rescale(idealheight*67/100), "class": "button-Style-curves",}) 
        .style("fill", "white") .on("click", curveLinkLength(curveLinktoPerson*0.5));    
        
svg.append("rect")        
        .attrs({"width": rescale(buttonWidth), "height": rescale(buttonWidth), "x": "92%", "y":rescale(idealheight*67/100), "class": "button-Style-curves",}) 
        .style("fill", "white") .on("click", curveLinkLength(curveLinktoPerson*0.75));    

svg.append("rect")        
        .attrs({"width": rescale(buttonWidth), "height": rescale(buttonWidth), "x": "94%", "y":rescale(idealheight*67/100), "class": "button-Style-curves",}) 
        .style("fill", "grey") .on("click", curveLinkLength(curveLinktoPerson*1.0));   

svg.append("rect")        
        .attrs({"width": rescale(buttonWidth), "height": rescale(buttonWidth), "x": "96%", "y":rescale(idealheight*67/100), "class": "button-Style-curves",}) 
        .style("fill", "white") .on("click", curveLinkLength(curveLinktoPerson*1.5)); 

//ZOOM HINT
svg.append("text")
            .attrs({"class": "button-Text",
                    "x": "81%", "y":"95%", 
                    })
            .style("font-size",rescale(12))
            .text("ZOOM OUT TO FIND THE TREE");   
        
//SIMULATION ON

        simulation
            .nodes(nodes)
            .on("tick", ticked);

        simulation.force("link")
            .links(links);
    }
//-----------------------------------------------------END TEXT //    

// FORCE PHYSICS FUNCTIONS """"""""""""""""""""""""""""""""""""""""""""""""""

    function linkDist(d,i){
        if(d.type =="marriage"){
            return linkDistance;
        } else {
            return linkDistance;
        }
    }
    
    function linkId(d){
        return d.id
        };

    
    
    function boxVertPosition(d,i){
        if(d.nodetype =="marriage"){
            return (idealheight - (idealheight/10*(d.gen-0.3)))*generationspacing;
        } else {
            return (idealheight - (idealheight/10*d.gen))*generationspacing;
        }
    }
    
    function boxHorizPosition(d){
        
            return d.xposition;
        
    }

    function boxCollision(d,i){
        if (d.branch > maxBranch){return 0} 
        else if(d.nodetype =="marriage"){return 0.5 * marriageBoxSize+ collisionPadding*2}
        else {return boxSize*0.5 + collisionPadding*2}
    }
    
    function chargeStrengthFunc(d,boxCharge,marriageCharge){
        if(d.nodetype =="marriage"){return marriageCharge}
        else {return boxCharge}
    }
    
    
    
// """""""""""""""""""""""""""""""""""""""""""""""""" END FORCE PHYSICS FUNCTIONS 

// LINK DISPLAY FUNCTIONS
    function linkColour(d){
            //else {return colors10(d.family)}}
            //else {return HSL(colors20c(d.gen),1,0.2,0.5,1,0.5)}} // by generation
            return HSL(colors10(d.family),lv[0],lv[1],lv[2],lv[3],lv[4],lv[5])} // by family  
    
    function linkOpacity(maxBranch){
        return function (d){
            if (d.branch > maxBranch || (d.branch == -1 && maxBranch<50)){return 0}
            if(maxBranch == 0 && d.linknos[0] < 2){return 0}
            if(maxBranch == 1 && d.linknos[1] < 2){return 0}
            if(maxBranch == 2 && d.linknos[2] < 2){return 0}
            if(maxBranch == 3 && d.linknos[3] < 2){return 0}
            if(maxBranch >= 4 && d.linknos[4] < 2){return 0}
            else {return 1}
        }
    } 
    
    //function linkOpacity(d){
    //    if (d.branch > maxBranch){return 0} 
    //    else if(d.type =="marriage"){return 0} 
    //    else {return 1}}
        
     function linkThickness(d){
     
        s = topScalingGen;
        q = useGenLinkScaling;
        
        if(d.branch == 0 && q){        
            if (s > d.gen){return Math.max(linkWidth[0]*((s-(d.gen-0.5))/s)*0.75,linkWidth[0]*0.25)} 
            else{return linkWidth[0]*0.25}
            }
        if(d.branch == 0){return linkWidth[0]}  
        
        if(d.branch > 0 && q){
        
            if (s > d.gen){return Math.max(linkWidth[1]*((s-(d.gen-0.5))/s)*0.75,linkWidth[1]*0.25)} 
            else{return linkWidth[1]*0.25}
            }
        else {return linkWidth[1]}
        }
        
        
        
// BOX FUNCTIONS ===============================================

    function maxAllTextWidths(d){
            return Math.max(boxSize,
                       getTextWidth(d.places[0], birthplaceScale, textfont),
                       getTextWidth(d.places[1], birthplaceScale, textfont),
                       getTextWidth(d.places[2], birthplaceScale, textfont),
                       getTextWidth(d.places[3], birthplaceScale, textfont),
                       getTextWidth(d.years[0], yearScale, textfont),
                       getTextWidth(d.occupation[0], occupationScale, textfont),
                       getTextWidth(d.occupation[1], occupationScale, textfont),
                       getTextWidth(d.occupation[2], occupationScale, textfont),
                       getTextWidth(d.occupation[3], occupationScale, textfont),
                       getTextWidth(d.custom[0], customScale, textfont),
                       getTextWidth(d.custom[1], customScale, textfont),
                       getTextWidth(d.custom[2], customScale, textfont),
                       getTextWidth(d.custom[3], customScale, textfont)

                       )
                       + topSpacing*2;    
             
    
    }
    
    
    function boxColour(d){
        if(d.nodetype =="marriage"){
            return "white"} 
            //else {return colors10(d.family)}}
            //else {return HSL(colors20c(d.gen),1,0.2,0.5,1,0.5)}} // by generation
            else {return HSL(colors10(d.family),bfv[0],bfv[1],bfv[2],bfv[3],bfv[4],bfv[5])}} // by family
    
    function boxStrokeColour(d){
            //else {return colors10(d.family)}}
            //else {return HSL(colors20c(d.gen),1,0.2,0.5,1,0.5)}} // by generation
            return HSL(colors10(d.family),bsv[0],bsv[1],bsv[2],bsv[3],bsv[4],bsv[5])} // by family  
    
    
    function boxWidth(maxBranch){
        return function (d){
            if (d.branch>maxBranch || (d.branch == -1 && maxBranch<50)){return 0}
            else if(d.nodetype =="marriage")
                {if(maxBranch == 0 && d.linknos[0] < 2){return 0}
                if(maxBranch == 1 && d.linknos[1] < 2){return 0}
                if(maxBranch == 2 && d.linknos[2] < 2){return 0}
                if(maxBranch == 3 && d.linknos[3] < 2){return 0}
                if(maxBranch >= 4 && d.linknos[4] < 2){return 0}
                else{return marriageBoxSize}
                }
                
            else {
            
            return maxAllTextWidths(d)}
        }
    } 
    
    function boxHeightReset(maxBranch){
        return function (d){
            if (d.branch>maxBranch || (d.branch == -1 && maxBranch<50)){return 0}
            else if(d.nodetype =="marriage"){return marriageBoxSize}
            else {var h = d.textHeight+topSpacing+textSpacing*0.5;
                    d.textHeight = 0;
                    return h}
        }
    } 
    
    function boxHeight(maxBranch){
        return function (d){
            if (d.branch>maxBranch || (d.branch == -1 && maxBranch<50)){return 0}
            else if(d.nodetype =="marriage"){return marriageBoxSize}
            else {return d.textHeight+topSpacing+textSpacing*0.5;}
        }
    } 
        
    
    function boxX(){
        return function (d){
            if(d.nodetype =="marriage"){return -0.5 * marriageBoxSize}
            else { return -0.5 * maxAllTextWidths(d)}
        }
     }
    
    function boxY(d){
        return function (d){
            if(d.nodetype =="marriage"){return -0.5 * marriageBoxSize}
            //else {return -0.5 * boxSize}}
            else {return 0}}
           }
        
    function shadowBoxX(shadowOffset){
        return function (d){
            if(d.nodetype =="marriage"){return -0.5 * marriageBoxSize +shadowOffset[0]}
            else { return -0.5 * maxAllTextWidths(d)+ shadowOffset[0]}
        }
     }
    
    function shadowBoxY(shadowOffset){
        return function (d){
        if(d.nodetype =="marriage"){return -0.5 * marriageBoxSize+shadowOffset[1]}
        //else {return -0.5 * boxSize}}
        else {return 0+shadowOffset[1]}
        }
        }
    
    function genColour(d){return HSL(colors20c(d.gen),bgv[0],bgv[1],bgv[2],bgv[3],bgv[4],bgv[5])}
    
    function branchColour(d){return HSL("red",bbv[0],d.branch*0.1,1-d.branch*0.1,1-d.branch*0.1,0.8,bbv[5])}
// =============================================== END BOX FUNCTIONS 


// TEXT FUNCTIONS -------------------------------------------------------------------

function getTextWidth(text, fontSize, fontFace) {
    
    context.font = fontSize + 'px ' + fontFace;
    return context.measureText(text).width;
} 

        
    function textOpacity(maxBranch){
        return function (d){
            if (d.branch>maxBranch || (d.branch == -1 && maxBranch<50)){return 0}
        else {return 1}
        }
    } 
//Names
    
    function nametext(line){
        return function (d){return d.names[line]}} 
    
    function namesize(line,fit,scale){
        return function (d){
            if (this.getComputedTextLength()> 1 ){
            var s = scale * Math.min(boxSize*0.9, (boxSize) / Math.max(this.getComputedTextLength(),fit) * 10); 
            d.textHeight +=s*0.5; 
            return s}
            else { return 0}
            
            }} //add half of current height


    function nameHeight(){
        return function (d){ 
                if (this.getComputedTextLength()> 1 ){
                s = d.textHeight; 
                d.textHeight+= (Math.min(boxSize*0.9, (boxSize) / this.getComputedTextLength() * 6))*0.5+textSpacing; 
                return s+topSpacing;}
                else { return 0}
                }} //add half of previous height 

                
    function textSize(scale){
        return function (d){
            if (this.getComputedTextLength()> 1 ){
            var s = scale; 
            d.textHeight +=s*0.5; 
            return s}
            else { return 0}
            
            }} //add half of current height

    function textHeight(scale){
        return function (d){ 
                if (this.getComputedTextLength()> 1 ){
                s = d.textHeight;
                d.textHeight+= scale*0.05+textSpacing; 
                return s+topSpacing;}
                else { return 0}
                }}                //add half of previous height             
///////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


//-----------------------------------------------------END TEXT FUNCTIONS// 
        

// TICK -----------------------------------------------------------------
    function ticked() {

        node

            .attr("transform", function (d) { return "translate(" + d.x + ", " + d.y + ")";});

        link.attr("d", dogleg);
    }
    
    
    
    function dogleg(d) {
          var dx = d.target.x - d.source.x,
              dy = d.target.y - d.source.y;

          if (scaleLinkCurves == true) {
          curveLinktoPerson = Math.max(Math.abs(dx*0.25),curveLinktoPerson);
          curveLinktoMarriage = Math.max(Math.abs(dx*0.1),curveLinktoMarriage);
          };
          
          var basepointY = d.source.y - Math.sign(d.source.y - d.target.y)*leglength,
              c1 = Math.min(curveLinktoPerson,Math.abs(dx)*(1-curveLinktoMarriage/curveLinktoPerson),Math.abs(d.target.y - basepointY))
              c2 = Math.min(curveLinktoMarriage,Math.abs(dx)-c1,Math.abs(d.source.y - basepointY))
              
              ty1 = basepointY+ Math.sign(d.target.y - basepointY)*c1
              tx1 = d.target.x+ Math.sign(d.source.x - d.target.x)*c1
              
              ty2 = basepointY+ Math.sign(d.source.y - basepointY)*c2
              tx2 = d.source.x+ Math.sign(d.target.x - d.source.x)*c2
              ;
          return "M" + d.source.x + "," + d.source.y + 
          "L" + d.source.x + "," + ty2 +
          //"S" + d.source.x + "," + basepointY + "," + d.source.x + "," + ty2 + 
          "S" + d.source.x + "," + basepointY + "," + tx2 + "," + basepointY + 
          "L" + tx1 + "," + basepointY +           
          "S" + d.target.x + "," + basepointY + "," + d.target.x + "," + ty1 + 
          "L" + d.target.x + "," + d.target.y;
          //https://www.dashingd3js.com/svg-paths-and-d3js
    }
// ----------------------------------------------------------------- END TICK    

    
// DRAGGING BEHAVIOUR ++++++++++++++++++++++++++++++++++++++++++++++++++++

    function dragstarted(d) {

        if (!d3.event.active) simulation.alphaTarget(0.3).restart()
        d.fx = d.x;
        d.fy = d.y;
    }

    
    function dragged(d) {

        d.fx = d3.event.x;
        d.fy = d3.event.y;}
    
//ctrl drag to keep node frozen in place
    function dragended(d) {
        
        if (!d3.event.active) simulation.alphaTarget(0);
        if (d3.event.sourceEvent.ctrlKey){
    
              d.fx = null;
              d.fy = null; 
              }
              
        else{
              d.fx = d.x;
              d.fy = d.y;
            }
         }
    
//single click to release frozen nodes                        
    function releasenode(d) {

        d.fx = null;
        d.fy = null; 
    }

// ++++++++++++++++++++++++++++++++++++++++++++++++++++ END DRAGGING BEHAVIOUR

    
// ADD ZOOM ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    
    var zoom_handler = d3.zoom()
        .on("zoom", zoom_actions);


    zoom_handler(svg); 

    function zoom_actions(){
        g.attr("transform", d3.event.transform)
    }
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~END ADD ZOOM
//Changing Parameters


var hidemarriages = (function(){
    return function(){
        d3.selectAll("circle").style("opacity", 0);
    }
    
    
})(); 



// Misc functions==================================================

    function HSL(col,hueRange,hueOffset,sat,val,fade,dark){
            var hsl = d3.hsl(col);
            hsl.h*=hueRange;
            hsl.h+=hueOffset*360;
            hsl.s*=sat;
            hsl.l*=val;
            var rgb = d3.rgb(hsl);
            rgb = d3.interpolateRgb(rgb,"white")
            rgb = d3.interpolateRgb(rgb(fade),"black")
            return rgb(dark)
    
    }

//sourced from http://bl.ocks.org/fancellu/2c782394602a93921faff74e594d1bb1
</script>

</body>
</html>